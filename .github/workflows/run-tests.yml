name: Run BDD Tests, Upload to Datadog, and Generate Allure Report

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# Update permissions for GitHub Pages deployment and potentially other actions
permissions:
  contents: write
  pages: write
  id-token: write

env:
  ALLURE_RESULTS_DIR: allure-results
  ALLURE_REPORT_DIR: allure-report
  JUNIT_RESULTS_DIR: junit-results # Directory for JUnit XML reports
  DATADOG_SERVICE_NAME: loyalty-program-tests # Unique service name for this repo
  DATADOG_SITE: datadoghq.eu # Change this if your site is different (e.g., datadoghq.com)

jobs:
  behave-tests:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18' # Or a recent LTS version

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        # Assuming requirements.txt contains behave, allure-behave, ddtrace (ddtrace might still be useful for custom metrics later, keep it for now)
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Install Datadog CI CLI
      run: npm install --global @datadog/datadog-ci

    - name: Run Behave Tests (JUnit & Allure)
      run: |
        # Create directories if they don't exist
        mkdir -p ${{ env.JUNIT_RESULTS_DIR }}
        mkdir -p ${{ env.ALLURE_RESULTS_DIR }}
        # Run behave with both JUnit and Allure formatters
        # Removed ddtrace-run, added --junit flag
        behave --junit --junit-directory ${{ env.JUNIT_RESULTS_DIR }} -f allure_behave.formatter:AllureFormatter -o ${{ env.ALLURE_RESULTS_DIR }} features/
      continue-on-error: true # Continue even if tests fail to allow report upload

    - name: Upload Test Results to Datadog
      if: always() # Run this step even if previous steps fail
      env:
        DD_API_KEY: ${{ secrets.DD_API_KEY }}
        # DD_SITE is already set in the global env
      run: |
        datadog-ci junit upload --service ${{ env.DATADOG_SERVICE_NAME }} ${{ env.JUNIT_RESULTS_DIR }}

    - name: Generate Allure Report
      if: always()
      run: |
        # Download and extract Allure
        curl -o allure-commandline.tgz -OLs https://repo.maven.apache.org/maven2/io/qameta/allure/allure-commandline/2.24.0/allure-commandline-2.24.0.tgz
        tar -zxvf allure-commandline.tgz
        
        # Run Allure directly from the extracted directory
        # This preserves the required directory structure
        ./allure-2.24.0/bin/allure generate ${{ env.ALLURE_RESULTS_DIR }} -o ${{ env.ALLURE_REPORT_DIR }} --clean
        
        # Clean up
        rm -rf allure-commandline.tgz

    - name: Archive Allure Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-report
        path: ${{ env.ALLURE_REPORT_DIR }}
        retention-days: 1

  # Separate job for GitHub Pages deployment
  deploy-pages:
    runs-on: ubuntu-latest
    needs: behave-tests
    if: always()
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        persist-credentials: true

    - name: Download Allure Report
      uses: actions/download-artifact@v4
      with:
        name: allure-report
        path: ${{ env.ALLURE_REPORT_DIR }}

    - name: Deploy to GitHub Pages
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git checkout --orphan gh-pages-temp
        git rm -rf .
        cp -r ${{ env.ALLURE_REPORT_DIR }}/* .
        touch .nojekyll
        git add .
        git commit -m "Update Allure report"
        git push -f origin gh-pages-temp:gh-pages

